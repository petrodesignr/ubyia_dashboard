<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
            <link rel="stylesheet" href="/style/style.css"/> 
            <link rel="stylesheet" href="/style/dashboard.css"/>
            <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
            <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
            <!-- Moment.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

<!-- Daterangepicker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

            
    </head>
    <body>
    <%- include('../header.ejs') -%>
    <%const dateNow = new Date().toLocaleDateString()%>
    <main class="table">
        <!-- table header avec le filtre date recherche et filtre de recherche -->
        <section class="dashboard">
            <div class="dashboard_header">
                <div id="filterbtn">
                    <button>
                        Filtre
                    </button>
                </div>
                <div class="search_box">  
                    <input type="search" placeholder="Recherche..." id="myInput" oninput="myFunction()">
                    <i class="fa fa-search"></i>
                </div>
            </div>
            
            <div class="main_pop_filter">
                <div>
                    <button>
                        <a href="/tickets/dashboard/filter/:page">reset filter</a>
                    </button>
                </div>

                <div class="date-filter">
                    <input
                        type="checkbox"
                        id="activateDateFilter"
                        <%= startDate && endDate%>
                    >
                    <label for="activateDateFilter">Filtrer par date</label>
                </div>
                <div id="reportrange">
                    <i class="fa fa-calendar"></i>
                    <span id="dateRangeLabel">
                        <%= moment(startDate).format('DD/MM/YYYY') %>-<%= moment(endDate).format('DD/MM/YYYY') %>
                    </span>
                    <i class="fa fa-caret-down"></i>
                </div>





                <form id="filterForm" method="GET" action="http://localhost:5001/tickets/dashboard/filter/1"> <!-- Default page is 1 -->
    <div>
        <h4>Staff</h4>
        <input 
            type="checkbox" 
            id="staff-<%= staff.staff_id %>" 
            name="staff_id" 
            value="<%= staff.staff_id %>">
        <label for="staff-<%= staff.staff_id %>"><%= staff.staff_name %></label>
    </div>

    <div>
        <h4>Priorité</h4>
        <% priority.forEach(option => { %>
            <div>
                <input 
                    type="checkbox" 
                    id="priority-<%= option.priority_id %>" 
                    name="priority_id" 
                    value="<%= option.priority_id %>">
                <label for="priority-<%= option.priority_id %>"><%= option.priority_name %></label>
            </div>
        <% }); %>
    </div>

    <div>
        <h4>Statut</h4>
        <% status.forEach(option => { %>
            <div>
                <input 
                    type="checkbox" 
                    id="status-<%= option.status_id %>" 
                    name="status_id" 
                    value="<%= option.status_id %>">
                <label for="status-<%= option.status_id %>"><%= option.status_name %></label>
            </div>
        <% }); %>
    </div>

    <button type="submit">Filtrer</button>
</form>



            </div>
        </section>
<!-- table body avec les contenus de la table de ticket -->
        <section class="table_body">
            <table id="ticketTable">
                <thead>
                    <tr>
                        <th ><p>Contact</p></th>
                        <th ><p>Client <span class="icon-arrow" data-column="1" data-order="asc">&UpArrow;</span></p></th>
                        <th ><p>Serveurs <span class="icon-arrow" data-column="2" data-order="asc">&UpArrow;</span></p></th>
                        <th ><p>Crée le <span class="icon-arrow" data-column="3" data-order="asc">&UpArrow;</span></p></th>
                        <th ><p>Modification Par <span class="icon-arrow" data-column="4" data-order="asc">&UpArrow;</span></p></th>
                        <th ><p>Priorité <span class="icon-arrow" data-column="5" data-order="asc">&UpArrow;</span></p></th>
                        <th ><p>Status <span class="icon-arrow" data-column="6" data-order="asc">&UpArrow;</span></p></th>
                        <th ><p>Message</p></th>
                    </tr>
                </thead>
                
                <tbody>
                    <% if (tickets && tickets.length > 0) { %>
                        <% tickets.forEach(ticket => { %>
                            <tr>
                                <td><%= ticket.user_firstname %> <%= ticket.user_lastname %><br><%= ticket.user_email %></td>
                                <td><%= ticket.company_name %></td>
                                <td><%= ticket.ubybox_serial_number %></td>
                                <td>
                                    Ticket #<%= ticket.ticket_id %><br>
                                    Le: <%= new Date(ticket.ticket_date_create).toLocaleDateString('fr-FR') %>
                                </td>
                                <td>
                                    <%= ticket.staff_first_name %> <%= ticket.staff_last_name %><br>
                                    Le: <%= ticket.message_date_create ? new Date(ticket.message_date_create).toLocaleDateString('fr-FR') : 'N/A' %>
                                </td>
                                <td>
                                    <!-- Priority Dropdown -->
                                    <select class="priority-dropdown color<%= ticket.priority_name.toLowerCase().replace(' ', '_') %>" data-ticket-id="<%= ticket.ticket_id %>">
                                        <% priority.forEach(option => { %>
                                            <option value="<%= option.priority_id %>" <%= ticket.priority_name === option.priority_name ? 'selected' : '' %>>
                                                <%= option.priority_name %>
                                            </option>
                                        <% }); %>
                                    </select>
                                </td>
                                <td>
                                    <!-- Status Dropdown -->
                                    <select class="status-dropdown color<%= ticket.status_name.toLowerCase().replace(' ', '_') %>" data-ticket-id="<%= ticket.ticket_id %>">
                                        <% status.forEach(option => { %>
                                            <option value="<%= option.status_id %>" <%= ticket.status_name === option.status_name ? 'selected' : '' %>>
                                                <%= option.status_name %>
                                            </option>
                                        <% }); %>
                                    </select>
                                </td>
                                <td>
                                    <i class="fa-regular fa-message fa-2x"></i>
                                </td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="8">No tickets available</td>
                        </tr>
                    <% } %>
                </tbody>



            </table>
            
        </section>
        <!-- Pagination -->
    <div class="pagination">
    <% if (totalTickets > 0) { %>
        <% if (currentPage > 1) { %>
            <a href="?page=<%= currentPage - 1 %>&status_id=<%= currentStatus || '' %>&priority_id=<%= currentPriority || '' %>&staff_id=<%= currentStaff || '' %>">
                Précédent
            </a>
        <% } %>

        <% for (let i = 1; i <= totalPages; i++) { %>
            <a href="?page=<%= i %>&status_id=<%= currentStatus || '' %>&priority_id=<%= currentPriority || '' %>&staff_id=<%= currentStaff || '' %>" 
               <% if (i === currentPage) { %> style="font-weight: bold;" <% } %>>
                <%= i %>
            </a>
        <% } %>

        <% if (currentPage < totalPages) { %>
            <a href="?page=<%= currentPage + 1 %>&status_id=<%= currentStatus || '' %>&priority_id=<%= currentPriority || '' %>&staff_id=<%= currentStaff || '' %>">
                Suivant
            </a>
        <% } %>
    <% } else { %>
        <p>Aucun ticket disponible pour le moment.</p>
    <% } %>
</div>

    <!-- Fin de la pagination ----->
    </main>
      </body>
      <script src="/script/dashboard.js"></script>
</html>